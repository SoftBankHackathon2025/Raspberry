name: CI/CD Pipeline for Microservices

on:
Â  pull_request:
Â  Â  branches:
Â  Â  Â  - main
Â  workflow_dispatch:

permissions:
Â  contents: read
Â  security-events: write

env:
Â  DOCKER_REGISTRY: kwa06001
Â  IMAGE_TAG: ${{ github.sha }}

jobs:
Â  test:
Â  Â  name: Run Unit Tests
Â  Â  runs-on: ubuntu-latest
Â  Â  steps:
Â  Â  Â  - name: Checkout repository
Â  Â  Â  Â  uses: actions/checkout@v4

Â  Â  Â  - name: Set up JDK 17
Â  Â  Â  Â  uses: actions/setup-java@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  java-version: '17'
Â  Â  Â  Â  Â  distribution: 'temurin'
Â  Â  Â  Â  Â  cache: 'gradle'

Â  Â  Â  - name: Grant execute permission for gradlew
Â  Â  Â  Â  run: chmod +x ./gradlew

Â  Â  Â  - name: Run Tests
Â  Â  Â  Â  run: ./gradlew test
Â  Â  Â  Â Â 
Â  docker-build-scan-push:
Â  Â  name: Docker Build, Scan & Push
Â  Â  needs: test
Â  Â  runs-on: ubuntu-latest
Â  Â  strategy:
Â  Â  Â  matrix:
Â  Â  Â  Â  service: [server, gateway, fe, deploy, user]
Â  Â  Â  fail-fast: false

Â  Â  steps:
Â  Â  Â  - name: Checkout repository
Â  Â  Â  Â  uses: actions/checkout@v4

Â  Â  Â  - name: Login to Docker Hub
Â  Â  Â  Â  uses: docker/login-action@v3
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  username: ${{ secrets.DOCKERHUB_USERNAME }}
Â  Â  Â  Â  Â  password: ${{ secrets.DOCKERHUB_PASSWORD }}

Â  Â  Â  - name: Set up Docker Buildx
Â  Â  Â  Â  uses: docker/setup-buildx-action@v3

Â  Â  Â  - name: Build Docker Image for ${{ matrix.service }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  IMAGE_NAME="${{ env.DOCKER_REGISTRY }}/${{ matrix.service }}"
Â  Â  Â  Â  Â  docker build \
Â  Â  Â  Â  Â  Â  -t $IMAGE_NAME:${{ env.IMAGE_TAG }} \
Â  Â  Â  Â  Â  Â  -t $IMAGE_NAME:latest \
Â  Â  Â  Â  Â  Â  -f ./${{ matrix.service }}/Dockerfile \
Â  Â  Â  Â  Â  Â  .

Â  Â  Â  - name: Run Trivy Security Scan
Â  Â  Â  Â  uses: aquasecurity/trivy-action@master
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  image-ref: ${{ env.DOCKER_REGISTRY }}/${{ matrix.service }}:${{ env.IMAGE_TAG }}
Â  Â  Â  Â  Â  format: 'sarif'
Â  Â  Â  Â  Â  output: 'trivy-results-${{ matrix.service }}.sarif'
Â  Â  Â  Â  Â  severity: 'CRITICAL,HIGH'
Â  Â  Â  Â  Â  exit-code: '0'

Â  Â  Â  - name: Upload Trivy Results to GitHub Security
Â  Â  Â  Â  uses: github/codeql-action/upload-sarif@v3
Â  Â  Â  Â  if: always()
Â  Â  Â  Â  continue-on-error: true
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  sarif_file: 'trivy-results-${{ matrix.service }}.sarif'
Â  Â  Â  Â  Â  category: 'trivy-${{ matrix.service }}'

Â  Â  Â  - name: Run Trivy Scan (Table Format)
Â  Â  Â  Â  uses: aquasecurity/trivy-action@master
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  image-ref: ${{ env.DOCKER_REGISTRY }}/${{ matrix.service }}:${{ env.IMAGE_TAG }}
Â  Â  Â  Â  Â  format: 'table'
Â  Â  Â  Â  Â  severity: 'CRITICAL,HIGH'

Â  Â  Â  - name: Push Docker Images
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  IMAGE_NAME="${{ env.DOCKER_REGISTRY }}/${{ matrix.service }}"
Â  Â  Â  Â  Â  docker push $IMAGE_NAME:${{ env.IMAGE_TAG }}
Â  Â  Â  Â  Â  docker push $IMAGE_NAME:latest
Â  Â  Â  Â  Â  echo "âœ… Pushed: $IMAGE_NAME:${{ env.IMAGE_TAG }} and latest"

Â  deploy-to-ec2:
Â  Â  name: Deploy to EC2
Â  Â  needs: docker-build-scan-push
Â  Â  runs-on: ubuntu-latest
Â  Â  if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
Â  Â  steps:
Â  Â  Â  - name: Checkout repository
Â  Â  Â  Â  uses: actions/checkout@v4

Â  Â  Â  - name: Update docker-compose.yml to use images
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  sed -i "s|build:\s*context: \.|image: kwa06001/server:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/image: kwa06001\/server/! s|build:\s*./server|image: kwa06001/server:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/dockerfile: \.\/server\/Dockerfile/d" docker-compose.yml
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  sed -i "s|build:\s*context: \.|image: kwa06001/gateway:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/image: kwa06001\/gateway/! s|build:\s*./gateway|image: kwa06001/gateway:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/dockerfile: \.\/gateway\/Dockerfile/d" docker-compose.yml

Â  Â  Â  Â  Â  sed -i "s|build:\s*context: \.|image: kwa06001/fe:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/image: kwa06001\/fe/! s|build:\s*./fe|image: kwa06001/fe:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/dockerfile: \.\/fe\/Dockerfile/d" docker-compose.yml
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  sed -i "s|build:\s*context: \.|image: kwa06001/deploy:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/image: kwa06001\/deploy/! s|build:\s*./deploy|image: kwa06001/deploy:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/dockerfile: \.\/deploy\/Dockerfile/d" docker-compose.yml
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  sed -i "s|build:\s*context: \.|image: kwa06001/user:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/image: kwa06001\/user/! s|build:\s*./user|image: kwa06001/user:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/dockerfile: \.\/user\/Dockerfile/d" docker-compose.yml
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "ğŸ“ Updated docker-compose.yml (to use images instead of build):"
Â  Â  Â  Â  Â  cat docker-compose.yml

Â  Â  Â  # AWS ìê²©ì¦ëª… ì„¤ì •
Â  Â  Â  - name: Configure AWS Credentials
Â  Â  Â  Â  uses: aws-actions/configure-aws-credentials@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
Â  Â  Â  Â  Â  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
Â  Â  Â  Â  Â  aws-region: ${{ secrets.AWS_REGION }}

Â  Â  Â  # AWS SSM Run Commandë¡œ ë°°í¬
Â  Â  Â  - name: Deploy to EC2 via AWS SSM
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  COMMAND_SCRIPT='''
Â  Â  Â  Â  Â  #!/bin/bash
Â  Â  Â  Â  Â  set -e
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "ğŸ“‚ Navigating to project directory..."
Â  Â  Â  Â  Â  cd /home/ubuntu/Raspberry # EC2 ë‚´ í”„ë¡œì íŠ¸ ê²½ë¡œ
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "ğŸ”§ Changing file ownership..."
Â  Â  Â  Â  Â  sudo chown -R $USER:$USER .
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "ğŸ”„ Pulling latest code..."
Â  Â  Â  Â  Â  git pull origin ${{ github.ref_name }}
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # === ğŸ’¡ ìŠ¤ì™‘ ë©”ëª¨ë¦¬ ì„¤ì • === (ì´í•˜ ì›ë³¸ ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš© ìœ ì§€)
Â  Â  Â  Â  Â  if [ -f /swapfile ]; then
Â  Â  Â  Â  Â  Â  echo "â„¹ï¸ Swap file /swapfile already exists."
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "ğŸš€ Creating 2G swap file..."
Â  Â  Â  Â  Â  Â  sudo fallocate -l 2G /swapfile
Â  Â  Â  Â  Â  Â  sudo chmod 600 /swapfile
Â  Â  Â  Â  Â  Â  sudo mkswap /swapfile
Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  if ! sudo swapon --show | grep -q "/swapfile"; then
Â  Â  Â  Â  Â  Â  echo "ğŸŸ¢ Activating swap..."
Â  Â  Â  Â  Â  Â  sudo swapon /swapfile
Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  if ! grep -q "/swapfile" /etc/fstab; then
Â  Â  Â  Â  Â  Â  echo "âœï¸ Adding swap to /etc/fstab..."
Â  Â  Â  Â  Â  Â  echo "/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab
Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  echo "ğŸ“Š Current swap status:"
Â  Â  Â  Â  Â  sudo swapon --show
Â  Â  Â  Â  Â  free -h
Â  Â  Â  Â  Â  # === ìŠ¤ì™‘ ë©”ëª¨ë¦¬ ì„¤ì • ë ===
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "ğŸ³ Logging in to Docker Hub..."
Â  Â  Â  Â  Â  echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "ğŸ”§ Granting Docker socket permissions..."
Â  Â  Â  Â  Â  sudo chmod 666 /var/run/docker.sock
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # [!!] EC2ì—ì„œ ì§ì ‘ sed ì‹¤í–‰ [!!]
Â  Â  Â  Â  Â  echo "ğŸ”§ Updating docker-compose.yml on EC2 to use images..."
Â  Â  Â  Â  Â  sed -i "s|build:\s*context: \.|image: kwa06001/server:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/image: kwa06001\/server/! s|build:\s*./server|image: kwa06001/server:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/dockerfile: \.\/server\/Dockerfile/d" docker-compose.yml
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  sed -i "s|build:\s*context: \.|image: kwa06001/gateway:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/image: kwa06001\/gateway/! s|build:\s*./gateway|image: kwa06001/gateway:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/dockerfile: \.\/gateway\/Dockerfile/d" docker-compose.yml
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  sed -i "s|build:\s*context: \.|image: kwa06001/fe:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/image: kwa06001\/fe/! s|build:\s*./fe|image: kwa06001/fe:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/dockerfile: \.\/fe\/Dockerfile/d" docker-compose.yml
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  sed -i "s|build:\s*context: \.|image: kwa06001/deploy:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/image: kwa06001\/deploy/! s|build:\s*./deploy|image: kwa06001/deploy:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/dockerfile: \.\/deploy\/Dockerfile/d" docker-compose.yml
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  sed -i "s|build:\s*context: \.|image: kwa06001/user:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/image: kwa06001\/user/! s|build:\s*./user|image: kwa06001/user:${{ env.IMAGE_TAG }}|g" docker-compose.yml
Â  Â  Â  Â  Â  sed -i "/dockerfile: \.\/user\/Dockerfile/d" docker-compose.yml
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "ğŸ“¥ Pulling latest Docker images from Docker Hub..."
Â  Â  Â  Â  Â  docker-compose pull
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "ğŸ›‘ Stopping and removing corrupted containers..."
Â  Â  Â  Â  Â  docker-compose down
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "ğŸš€ Starting services with new images..."
Â  Â  Â  Â  Â  docker-compose up -d --remove-orphans
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "ğŸ§¹ Cleaning up old images..."
Â  Â  Â  Â  Â  docker image prune -a -f
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "â³ Waiting for services to start..."
Â  Â  Â  Â  Â  sleep 15
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "âœ… Deployment completed!"
Â  Â  Â  Â  Â  docker-compose ps
Â  Â  Â  Â  ''' # ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„: COMMAND_SCRIPTì™€ ê°™ì€ ì—´ì— ìœ„ì¹˜
Â  Â  Â  Â  
Â  Â  Â  Â  # ğŸ’¡ AWS CLI send-command í˜¸ì¶œ
Â  Â  Â  Â  aws ssm send-command \
Â  Â  Â  Â  Â  --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
Â  Â  Â  Â  Â  --document-name "AWS-RunShellScript" \
Â  Â  Â  Â  Â  --parameters commands="$COMMAND_SCRIPT" \
Â  Â  Â  Â  Â  --timeout-seconds 600 \
Â  Â  Â  Â  Â  --output text

Â  Â  Â  # AWS SSMìœ¼ë¡œ ë°°í¬ ê²€ì¦
Â  Â  Â  - name: Verify Deployment
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  VERIFY_SCRIPT='''
Â  Â  Â  Â  Â  #!/bin/bash
Â  Â  Â  Â  Â  set -e

Â  Â  Â  Â  Â  echo "â³ Waiting for services to initialize..."
Â  Â  Â  Â  Â  sleep 50

Â  Â  Â  Â  Â  cd /home/ubuntu/Raspberry

Â  Â  Â  Â  Â  echo "ğŸ” Checking service health..."

Â  Â  Â  Â  Â  if curl -sf http://localhost:8761 > /dev/null 2>&1; then
Â  Â  Â  Â  Â  Â  echo "âœ… Eureka Server is healthy"
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "âŒ Eureka Server health check failed"
Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  if curl -sf http://localhost:8080/actuator/health > /dev/null 2>&1; then
Â  Â  Â  Â  Â  Â  echo "âœ… Gateway is healthy"
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "âš ï¸ Gateway health check failed"
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  echo "ğŸ“Š Service Status:"
Â  Â  Â  Â  Â  docker-compose ps
Â  Â  Â  Â  ''' # ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„: VERIFY_SCRIPTì™€ ê°™ì€ ì—´ì— ìœ„ì¹˜
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  aws ssm send-command \
Â  Â  Â  Â  Â  Â  --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
Â  Â  Â  Â  Â  Â  --document-name "AWS-RunShellScript" \
Â  Â  Â  Â  Â  Â  --parameters commands="$VERIFY_SCRIPT" \
Â  Â  Â  Â  Â  Â  --timeout-seconds 300 \
Â  Â  Â  Â  Â  Â  --output text

Â  Â  Â  # Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
Â  Â  Â  - name: Notify Deployment Status
Â  Â  Â  Â  if: always()
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  if [ "${{ job.status }}" == "success" ]; then
Â  Â  Â  Â  Â  Â  echo "âœ… Deployment successful to EC2"
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "âŒ Deployment failed!"
Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  fi
