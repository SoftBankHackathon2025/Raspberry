<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deploy Â· GitHub Actions (Live Logs)</title>
  <style>
    :root{--bg:#0b1220;--fg:#e5e7eb;--muted:#9ca3af;--accent:#7c3aed;--ok:#10b981;--err:#ef4444;--warn:#f59e0b}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0}
    body{display:grid;place-items:start;background:radial-gradient(800px 500px at 10% 0%, #121a2f, #0b1220);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;padding:20px}
    .card{width:min(920px,100%);background:rgba(255,255,255,.04);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,.35);padding:22px;margin:0 auto}
    h1{margin:0 0 8px;font-size:18px}
    p{margin:0 0 12px;color:var(--muted);font-size:14px}
    .grid{display:grid;gap:14px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .input-group{margin-bottom:4px}
    .input-group label{display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--fg)}
    .input-group input{width:100%;padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:10px;color:var(--fg);font-size:14px;font-family:ui-monospace,Menlo,Consolas,monospace}
    .input-group input:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,.08)}
    .btn{appearance:none;border:0;border-radius:14px;padding:12px 16px;font-weight:800;letter-spacing:.2px;cursor:pointer;background:linear-gradient(180deg,var(--accent),#6d28d9);color:white;box-shadow:0 10px 20px rgba(124,58,237,.35)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:linear-gradient(180deg,#374151,#1f2937);box-shadow:0 10px 20px rgba(0,0,0,.2)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .status{margin-top:14px;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;word-break:break-all}
    .ok{color:var(--ok)}.err{color:var(--err)}.warn{color:var(--warn)}
    .hint{margin-top:10px;padding:10px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;font-size:12px;color:#fca5a5}
    .kbd{font-family:ui-monospace,Menlo,monospace;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-bottom-width:2px;padding:1px 6px;border-radius:6px}
    .small{font-size:12px}
    .token-saved{display:none;align-items:center;gap:8px;padding:8px 12px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:8px;font-size:12px;color:var(--ok);margin-bottom:12px}
    .token-saved.show{display:flex}
    .section{margin-top:18px;padding:14px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(255,255,255,.03)}
    .flex{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:9999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);font-size:12px}
    .logbox{margin-top:10px;background:#000;border:1px solid rgba(255,255,255,.12);border-radius:10px;color:#e5e7eb;padding:10px;min-height:240px;max-height:420px;overflow:auto;white-space:pre-wrap}
    .row-right{margin-left:auto}
    .iframe-container{margin-top:20px}
    .iframe-container h3{margin:0 0 10px;font-size:16px;color:var(--fg)}
    .iframe-container iframe{width:100%;height:400px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.02)}
    .link{color:var(--accent);text-decoration:none;font-weight:600}
    .link:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸš€ GitHub Actions ë°°í¬ íŠ¸ë¦¬ê±° + ë¼ì´ë¸Œ ë¡œê·¸</h1>
    <p class="small">ë²„íŠ¼ í•˜ë‚˜ë¡œ <span class="kbd">workflow_dispatch</span> ì´ë²¤íŠ¸ë¥¼ í˜¸ì¶œí•˜ê³ , <strong>ë°°í¬ Job(Deploy to EC2)</strong>ì˜ ë¡œê·¸ì™€ <strong>ì†Œìš” ì‹œê°„</strong>ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>

    <div id="tokenSaved" class="token-saved">
      <span>âœ“</span>
      <span>í† í°ì´ ì„¸ì…˜ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (íƒ­ ë‹«ìœ¼ë©´ ì‚­ì œ)</span>
    </div>

    <div class="grid cols-2">
      <div class="input-group">
        <label for="tokenInput">GitHub Personal Access Token</label>
        <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxxxxxxxx" autocomplete="off" />
      </div>
      <div class="input-group">
        <label for="branchInput">Branch (ref)</label>
        <input id="branchInput" value="feat/LandingPage" />
      </div>
      <div class="input-group">
        <label for="ownerInput">Owner</label>
        <input id="ownerInput" value="SoftBankHackathon2025" />
      </div>
      <div class="input-group">
        <label for="repoInput">Repo</label>
        <input id="repoInput" value="Raspberry" />
      </div>
      <div class="input-group">
        <label for="workflowInput">Workflow file</label>
        <input id="workflowInput" value="ci-cd.yml" />
      </div>
      <div class="input-group">
        <label for="jobNameInput">Deploy Job name</label>
        <input id="jobNameInput" value="Deploy to EC2" />
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="saveBtn" class="btn btn-secondary" type="button">ğŸ’¾ í† í° ì €ì¥ (ì„¸ì…˜)</button>
      <button id="deployBtn" class="btn" type="button">ğŸš€ ë°°í¬ ì‹¤í–‰</button>
      <button id="watchBtn" class="btn btn-secondary" type="button">ğŸ‘€ ìµœì‹  ì‹¤í–‰ ëª¨ë‹ˆí„°ë§</button>
      <button id="stopBtn" class="btn btn-secondary" type="button" disabled>â¹ï¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
    </div>

    <div id="status" class="status" role="status" aria-live="polite">ëŒ€ê¸° ì¤‘â€¦</div>

    <div class="section">
      <div class="flex">
        <div class="chip">Run ID: <span id="runId" class="mono">-</span></div>
        <div class="chip">Job ID: <span id="jobId" class="mono">-</span></div>
        <div class="chip">Job Status: <span id="jobStatus" class="mono">-</span></div>
        <div class="chip">Conclusion: <span id="jobConclusion" class="mono">-</span></div>
        <div class="chip row-right">â±ï¸ Elapsed: <span id="elapsed" class="mono">00:00:00</span></div>
      </div>
      <div class="flex" style="margin-top:8px">
        <div class="chip">Started: <span id="startedAt" class="mono">-</span></div>
        <div class="chip">Completed: <span id="completedAt" class="mono">-</span></div>
        <a id="runLink" class="link row-right" href="#" target="_blank" rel="noreferrer">GitHub Actionsì—ì„œ ë³´ê¸° â†—</a>
      </div>
      <div id="stepsBox" class="small" style="margin-top:10px;color:var(--muted)"></div>
      <div id="logBox" class="logbox mono"></div>
      <div class="row" style="margin-top:8px">
        <button id="downloadBtn" class="btn btn-secondary" type="button" disabled>â¬‡ï¸ í˜„ì¬ ë¡œê·¸ ì €ì¥</button>
        <button id="refreshBtn" class="btn btn-secondary" type="button" disabled>ğŸ”„ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>

    <div class="hint">
      <strong>âš ï¸ ë³´ì•ˆ ì£¼ì˜ì‚¬í•­:</strong><br>
      â€¢ Personal Access Tokenì€ <strong>Actions: read/write</strong>, <strong>Contents: read</strong> ê¶Œí•œ í•„ìš”<br>
      â€¢ í† í°ì€ sessionStorageì—ë§Œ ì €ì¥ (íƒ­ ë‹«ìœ¼ë©´ ìë™ ì‚­ì œ) Â· ì ˆëŒ€ ì»¤ë°‹ ê¸ˆì§€<br>
      â€¢ Fineâ€‘grained token ì‚¬ìš© ê¶Œì¥ (í•´ë‹¹ ë ˆí¬ì—ë§Œ ì œí•œ)
    </div>

    <div class="iframe-container">
      <h3>ğŸŒ Eureka Service Registry</h3>
      <iframe src="http://3.34.94.55:8761/" title="Eureka Server Dashboard" frameborder="0"></iframe>
    </div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const statusEl = $('#status');
    const tokenSaved = $('#tokenSaved');

    const state = {
      polling: false,
      runId: null,
      jobId: null,
      jobName: null,
      startedAt: null,
      completedAt: null,
      elapsedTimer: null,
      headers: null,
    };

    const setStatus = (t, cls) => { statusEl.className = 'status' + (cls? ' ' + cls : ''); statusEl.textContent = t; };
    const fmt = (n)=> String(n).padStart(2,'0');
    const fmtDuration = (ms) => { if(ms==null||isNaN(ms)) return '00:00:00'; const s=Math.floor(ms/1000); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const ss=s%60; return `${fmt(h)}:${fmt(m)}:${fmt(ss)}`; };
    const iso = (x)=> x? new Date(x).toLocaleString() : '-';

    const getHeaders = (token) => ({
      'Accept':'application/vnd.github+json',
      'Authorization':`Bearer ${token}`,
      'X-GitHub-Api-Version':'2022-11-28'
    });

    const api = async (url, opt={}) => {
      const res = await fetch(url, { ...opt, headers: { ...(opt.headers||{}), ...(state.headers||{}) } });
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      return res.json();
    };

    const listLatestRun = async ({owner, repo, workflow, branch, event='workflow_dispatch'}) => {
      const url = new URL(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/${workflow}/runs`);
      url.searchParams.set('per_page','1');
      if(branch) url.searchParams.set('branch',branch);
      if(event) url.searchParams.set('event',event);
      const data = await api(url);
      return data.workflow_runs?.[0] || null;
    };

    const listJobs = async ({owner, repo, runId}) => {
      const url = new URL(`https://api.github.com/repos/${owner}/${repo}/actions/runs/${runId}/jobs`);
      url.searchParams.set('per_page','100');
      url.searchParams.set('filter','latest');
      const data = await api(url);
      return data.jobs || [];
    };

    const fetchJobLogText = async ({owner, repo, jobId}) => {
      const url = `https://api.github.com/repos/${owner}/${repo}/actions/jobs/${jobId}/logs`;
      // ìš°ì„  follow
      let res = await fetch(url, { headers: state.headers, redirect:'follow' });
      if(res.ok) return await res.text();
      // ìˆ˜ë™ìœ¼ë¡œ Location ì¶”ì¶œ
      res = await fetch(url, { headers: state.headers, redirect:'manual' });
      const loc = res.headers.get('Location');
      if(!loc) throw new Error('ë¡œê·¸ URLì„ ì–»ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
      const res2 = await fetch(loc);
      if(!res2.ok) throw new Error('ë¡œê·¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
      return await res2.text();
    };

    // ====== UI Actions ======
    function saveToken(){
      const t = $('#tokenInput').value.trim();
      if(!t){ setStatus('âŒ í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”','err'); return; }
      sessionStorage.setItem('gh_token', t);
      tokenSaved.classList.add('show');
      setStatus('âœ… í† í°ì´ ì„¸ì…˜ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤','ok');
    }

    async function triggerDispatch(){
      const token = $('#tokenInput').value.trim();
      if(!token){ setStatus('âŒ GitHub Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”','err'); $('#tokenInput').focus(); return; }
      state.headers = getHeaders(token);

      const owner = $('#ownerInput').value.trim();
      const repo = $('#repoInput').value.trim();
      const workflow = $('#workflowInput').value.trim();
      const ref = $('#branchInput').value.trim();
      const jobName = $('#jobNameInput').value.trim();
      state.jobName = jobName;

      setStatus('ìš”ì²­ ì „ì†¡ ì¤‘â€¦');
      $('#deployBtn').disabled = true;

      const url = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/${workflow}/dispatches`;
      const body = JSON.stringify({ ref, inputs: { env:'dev' } });
      const res = await fetch(url, { method:'POST', headers:{...state.headers,'Content-Type':'application/json'}, body });
      if(res.status !== 204){
        const txt = await res.text().catch(()=> '');
        setStatus(`âŒ íŠ¸ë¦¬ê±° ì‹¤íŒ¨: HTTP ${res.status} ${txt || ''}`,'err');
        $('#deployBtn').disabled = false; return;
      }
      setStatus('âœ… íŠ¸ë¦¬ê±° ì„±ê³µ! ì‹¤í–‰ì„ ì°¾ëŠ” ì¤‘â€¦','ok');

      // ìµœì‹  ì‹¤í–‰ì´ ì˜¬ë¼ì˜¬ ë•Œê¹Œì§€ í´ë§ í›„ ëª¨ë‹ˆí„°ë§ ì‹œì‘
      await watchLatest({owner, repo, workflow, branch: ref});
      $('#deployBtn').disabled = false;
    }

    async function watchLatest({owner, repo, workflow, branch}){
      const startedAt = Date.now();
      state.polling = true; $('#stopBtn').disabled = false; $('#watchBtn').disabled = true;

      // ìµœì‹  runì´ ìƒì„±ë  ë•Œê¹Œì§€ ëŒ€ê¸°
      let run = null; let tries = 0;
      while(state.polling && tries < 30){ // ìµœëŒ€ ~30ì´ˆ ëŒ€ê¸°
        run = await listLatestRun({owner, repo, workflow, branch, event:'workflow_dispatch'}).catch(()=>null);
        if(run && new Date(run.created_at).getTime() >= startedAt - 5000) break; // ìƒˆë¡œ ìƒì„±ëœ ì‹¤í–‰ìœ¼ë¡œ ê°„ì£¼
        await sleep(1000); tries++;
      }
      if(!run){ setStatus('âŒ ì‹¤í–‰ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤','err'); return; }

      state.runId = run.id; $('#runId').textContent = run.id; $('#runLink').href = run.html_url || `https://github.com/${owner}/${repo}/actions/runs/${run.id}`;
      setStatus(`â–¶ï¸ Run ${run.id} Â· status=${run.status}`,'ok');

      await watchDeployJob({owner, repo, runId: run.id});
    }

    async function watchByLatestButton(){
      const token = $('#tokenInput').value.trim();
      if(!token){ setStatus('âŒ GitHub Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”','err'); return; }
      state.headers = getHeaders(token);
      const owner = $('#ownerInput').value.trim();
      const repo = $('#repoInput').value.trim();
      const workflow = $('#workflowInput').value.trim();
      const ref = $('#branchInput').value.trim();
      state.jobName = $('#jobNameInput').value.trim();
      await watchLatest({owner, repo, workflow, branch: ref});
    }

    async function watchDeployJob({owner, repo, runId}){
      state.polling = true; $('#stopBtn').disabled = false; $('#refreshBtn').disabled = false; $('#downloadBtn').disabled = true;
      const jobName = state.jobName || 'Deploy to EC2';

      let job = null; let tries = 0;
      while(state.polling){
        const jobs = await listJobs({owner, repo, runId}).catch(()=>({}));
        job = (jobs||[]).find(j => (j.name||'').toLowerCase() === jobName.toLowerCase()) || null;
        if(job) break;
        if(++tries>120){ setStatus('âŒ ë°°í¬ Jobì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤','err'); return; }
        setStatus('ë°°í¬ Job ëŒ€ê¸° ì¤‘â€¦','warn'); await sleep(1000);
      }

      // ë©”íƒ€ í‘œì‹œ & íƒ€ì´ë¨¸ ì‹œì‘
      state.jobId = job.id; $('#jobId').textContent = job.id; updateJobMeta(job);
      startElapsed(job.started_at, job.completed_at);

      // ë¡œê·¸ í´ë§ ë£¨í”„
      while(state.polling){
        await loadAndRenderLogs({owner, repo, jobId: job.id});
        // Job ìƒíƒœ ê°±ì‹ 
        const jobs = await listJobs({owner, repo, runId}).catch(()=>({}));
        const updated = (jobs||[]).find(j => j.id === job.id) || job;
        job = updated; updateJobMeta(job);
        if(job.status === 'completed') break;
        await sleep(3000);
      }

      // ì™„ë£Œ ì²˜ë¦¬
      stopElapsed(job.completed_at);
      $('#downloadBtn').disabled = false; setStatus(`âœ… ë°°í¬ Job ì™„ë£Œ Â· conclusion=${job.conclusion || '-'}`,(job.conclusion==='success'?'ok': 'err'));
      $('#stopBtn').disabled = true; $('#watchBtn').disabled = false;
    }

    function updateJobMeta(job){
      $('#jobStatus').textContent = job.status || '-';
      $('#jobConclusion').textContent = job.conclusion || '-';
      $('#startedAt').textContent = iso(job.started_at);
      $('#completedAt').textContent = iso(job.completed_at);
      state.startedAt = job.started_at; state.completedAt = job.completed_at || null;
      // Steps ìš”ì•½
      const steps = (job.steps||[]).map(s=>{
        const dur = s.started_at && s.completed_at ? (new Date(s.completed_at)-new Date(s.started_at)) : null;
        return `â€¢ ${s.name} â€” ${s.conclusion || s.status || '-'} (${dur? fmtDuration(dur): 'Â·Â·Â·'})`;
      }).join('\n');
      $('#stepsBox').textContent = steps || 'Steps ì •ë³´ ì—†ìŒ';
    }

    async function loadAndRenderLogs({owner, repo, jobId}){
      try{
        const text = await fetchJobLogText({owner, repo, jobId});
        const logBox = $('#logBox');
        const atBottom = Math.abs(logBox.scrollHeight - logBox.scrollTop - logBox.clientHeight) < 4;
        logBox.textContent = text;
        if(atBottom) logBox.scrollTop = logBox.scrollHeight;
      }catch(e){
        setStatus('ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨: '+ e.message,'err');
      }
    }

    function startElapsed(startIso, endIso){
      clearInterval(state.elapsedTimer);
      const start = startIso ? new Date(startIso).getTime() : Date.now();
      const end = endIso ? new Date(endIso).getTime() : null;
      const tick = () => {
        const now = Date.now();
        const ms = (end? end : now) - start;
        $('#elapsed').textContent = fmtDuration(ms);
      };
      tick();
      state.elapsedTimer = setInterval(tick, 1000);
    }

    function stopElapsed(endIso){
      if(endIso){ startElapsed(state.startedAt, endIso); }
      clearInterval(state.elapsedTimer); state.elapsedTimer = null;
    }

    function sleep(ms){ return new Promise(r=> setTimeout(r, ms)); }

    // ====== Buttons ======
    $('#saveBtn').addEventListener('click', saveToken);
    $('#deployBtn').addEventListener('click', () => triggerDispatch().catch(e=> setStatus('âŒ '+e.message,'err')));
    $('#watchBtn').addEventListener('click', () => watchByLatestButton().catch(e=> setStatus('âŒ '+e.message,'err')));

    $('#stopBtn').addEventListener('click', ()=>{ state.polling=false; clearInterval(state.elapsedTimer); $('#stopBtn').disabled = true; $('#watchBtn').disabled = false; setStatus('â¹ï¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€','warn'); });
    $('#refreshBtn').addEventListener('click', async ()=>{
      if(!state.jobId){ setStatus('Job ID ì—†ìŒ','err'); return; }
      const owner = $('#ownerInput').value.trim(); const repo = $('#repoInput').value.trim();
      await loadAndRenderLogs({owner, repo, jobId: state.jobId});
    });
    $('#downloadBtn').addEventListener('click', ()=>{
      const text = $('#logBox').textContent || '';
      const blob = new Blob([text], {type:'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const rid = $('#runId').textContent || 'run';
      const jid = $('#jobId').textContent || 'job';
      a.download = `deploy-log-${rid}-${jid}.log`;
      a.click(); URL.revokeObjectURL(a.href);
    });

    // Restore token on load
    (function init(){
      const saved = sessionStorage.getItem('gh_token');
      if(saved){ $('#tokenInput').value = saved; tokenSaved.classList.add('show'); }
    })();
  </script>
</body>
</html>
